
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://slaclab.github.io/lume-epics/Server/">
      
      
        <link rel="prev" href="../Model/">
      
      
        <link rel="next" href="../EPICS/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.17">
    
    
      
        <title>Server - lume-epics</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#epics-server" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="lume-epics" class="md-header__button md-logo" aria-label="lume-epics" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            lume-epics
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Server
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/slaclab/lume-epics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Overview
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../Install/" class="md-tabs__link">
      Install
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../BokehServer/" class="md-tabs__link">
        Tutorial
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../Widgets_doc/" class="md-tabs__link">
      Widgets
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../Controller/" class="md-tabs__link md-tabs__link--active">
        API
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="lume-epics" class="md-nav__button md-logo" aria-label="lume-epics" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    lume-epics
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/slaclab/lume-epics" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Install/" class="md-nav__link">
        Install
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../BokehServer/" class="md-nav__link">
        Bokeh Server
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Widgets_doc/" class="md-nav__link">
        Widgets
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
      
      
      
        <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
          Client
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Client
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Controller/" class="md-nav__link">
        Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Monitors/" class="md-nav__link">
        Monitors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Widgets/" class="md-nav__link">
        Widgets
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Model/" class="md-nav__link">
        Model
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Server
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_server" class="md-nav__link">
    lume_epics.epics_server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_server.Server" class="md-nav__link">
    Server
  </a>
  
    <nav class="md-nav" aria-label="Server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_server.Server.__enter__" class="md-nav__link">
    __enter__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_server.Server.__exit__" class="md-nav__link">
    __exit__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_server.Server.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_server.Server.run_comm_thread" class="md-nav__link">
    run_comm_thread()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_server.Server.start" class="md-nav__link">
    start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_server.Server.stop" class="md-nav__link">
    stop()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server" class="md-nav__link">
    lume_epics.epics_ca_server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CADriver" class="md-nav__link">
    CADriver
  </a>
  
    <nav class="md-nav" aria-label="CADriver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CADriver.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CADriver.read" class="md-nav__link">
    read()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CADriver.update_pvs" class="md-nav__link">
    update_pvs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CADriver.write" class="md-nav__link">
    write()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServer" class="md-nav__link">
    CAServer
  </a>
  
    <nav class="md-nav" aria-label="CAServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServer.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServer.setup_server" class="md-nav__link">
    setup_server()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServer.shutdown" class="md-nav__link">
    shutdown()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServer.update_pv" class="md-nav__link">
    update_pv()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServer.update_pvs" class="md-nav__link">
    update_pvs()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServerThread" class="md-nav__link">
    CAServerThread
  </a>
  
    <nav class="md-nav" aria-label="CAServerThread">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServerThread.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServerThread.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.CAServerThread.stop" class="md-nav__link">
    stop()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_ca_server.build_pvdb" class="md-nav__link">
    build_pvdb()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server" class="md-nav__link">
    lume_epics.epics_pva_server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAServer" class="md-nav__link">
    PVAServer
  </a>
  
    <nav class="md-nav" aria-label="PVAServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAServer.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAServer.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAServer.setup_server" class="md-nav__link">
    setup_server()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAServer.shutdown" class="md-nav__link">
    shutdown()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAServer.update_pv" class="md-nav__link">
    update_pv()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAServer.update_pvs" class="md-nav__link">
    update_pvs()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAccessInputHandler" class="md-nav__link">
    PVAccessInputHandler
  </a>
  
    <nav class="md-nav" aria-label="PVAccessInputHandler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAccessInputHandler.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lume_epics.epics_pva_server.PVAccessInputHandler.put" class="md-nav__link">
    put()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../EPICS/" class="md-nav__link">
        EPICS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="epics-server">EPICS Server</h1>
<p>The lume-epics server synchronizes process variables over Channel Access and pvAccess servers. Updates to input process variables are queued for model execution and the model output is queued for updates over both protocols. </p>
<p><img alt="Server Structure" src="../img/lume-epics.jpeg" /></p>


<div class="doc doc-object doc-module">


<a id="lume_epics.epics_server"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="lume_epics.epics_server.Server" class="doc doc-heading">
        <code>Server</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Server for EPICS process variables. Can be optionally initialized with only
pvAccess or Channel Access protocols.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code><span title="lume_model.models.BaseModel">BaseModel</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Instantiated model</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>input_variables</code></td>
          <td>
                <code>Dict[str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>InputVariable]): Model input variables</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>output_variables</code></td>
          <td>
                <code>Dict[str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>OutputVariable]): Model output variables</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>epics_config</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>...</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_pva_fields</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of variables pointing to pvAccess fields</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_protocols</code></td>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of protocols in use</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>in_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              
            </div>
          </td>
        </tr>
        <tr>
          <td><code>out_queues</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, multiprocessing.<span title="multiprocessing.Queue">Queue</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue updates to output
variables to protocol servers.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>exit_event</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Event">Event</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Event triggering shutdown</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_running_indicator</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Value">Value</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Value indicating whether server is running</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_process_exit_events</code></td>
          <td>
                <code><span title="typing.List">List</span>[multiprocessing.<span title="multiprocessing.Event">Event</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Exit events for each process</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_model_exec_exit_event</code></td>
          <td>
                <code><span title="threading.Event">Event</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Thread event for model execution exceptions</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>comm_thread</code></td>
          <td>
                <code><span title="threading.Thread">Thread</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Thread for model execution</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ca_process</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Process">Process</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Channel access server process</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>pva_process</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Process">Process</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pvAccess server process</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>lume_epics/epics_server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Server</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server for EPICS process variables. Can be optionally initialized with only</span>
<span class="sd">    pvAccess or Channel Access protocols.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model (BaseModel): Instantiated model</span>

<span class="sd">        input_variables (Dict[str: InputVariable]): Model input variables</span>

<span class="sd">        output_variables (Dict[str: OutputVariable]): Model output variables</span>

<span class="sd">        epics_config (Optional[Dict]): ...</span>

<span class="sd">        _pva_fields (List[str]): List of variables pointing to pvAccess fields</span>

<span class="sd">        _protocols (List[str]): List of protocols in use</span>

<span class="sd">        in_queue (multiprocessing.Queue):</span>

<span class="sd">        out_queues (Dict[str, multiprocessing.Queue]): Queue updates to output</span>
<span class="sd">            variables to protocol servers.</span>

<span class="sd">        exit_event (multiprocessing.Event): Event triggering shutdown</span>

<span class="sd">        _running_indicator (multiprocessing.Value): Value indicating whether server is running</span>

<span class="sd">        _process_exit_events (List[multiprocessing.Event]): Exit events for each process</span>

<span class="sd">        _model_exec_exit_event (Event): Thread event for model execution exceptions</span>

<span class="sd">        comm_thread (Thread): Thread for model execution</span>

<span class="sd">        ca_process (multiprocessing.Process): Channel access server process</span>

<span class="sd">        pva_process (multiprocessing.Process): pvAccess server process</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span>
        <span class="n">epics_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># TODO DROP and use instantiated mode</span>
        <span class="n">epics_env</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># TODO drop hashable default. Should be Optional[dict]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create model_class instance and configure both Channel Access and pvAccess</span>
<span class="sd">        servers for execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_class (Type[BaseModel]): Model class to be instantiated</span>

<span class="sd">            epics_config (dict): Dictionary describing EPICS configuration for model</span>
<span class="sd">                variables.</span>

<span class="sd">            model_kwargs (dict): Kwargs to instantiate model.</span>

<span class="sd">            epics_env (dict): Environment variables for EPICS configuration.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Update epics environment if programatically set</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">EPICS_ENV_VARS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">epics_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">epics_env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_variables</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span> <span class="o">=</span> <span class="n">epics_config</span>

        <span class="c1"># define programatic access to model summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_date_published</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># If configured, set up summary pv</span>
        <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pvname&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_date_published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;date_published&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">ca_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">pva_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pva&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span>
        <span class="p">}</span>

        <span class="c1"># track nested fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pva_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pva_fields</span> <span class="o">+=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ca_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ca&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pva_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pva&quot;</span><span class="p">)</span>

        <span class="c1"># set up protocol based queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="c1"># exit event for triggering shutdown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># event for shutdown on model execution exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_exec_exit_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

        <span class="c1"># we use the running marker to make sure pvs + ca don&#39;t just keep adding queue elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_comm_thread</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;in_queue&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="p">,</span>
                <span class="s2">&quot;out_queues&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">,</span>
                <span class="s2">&quot;running_indicator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># initialize channel access server</span>
        <span class="k">if</span> <span class="s2">&quot;ca&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="n">ca_input_vars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
                <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">ca_config</span>
            <span class="p">}</span>
            <span class="n">ca_output_vars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
                <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">ca_config</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span> <span class="o">=</span> <span class="n">CAServer</span><span class="p">(</span>
                <span class="n">input_variables</span><span class="o">=</span><span class="n">ca_input_vars</span><span class="p">,</span>
                <span class="n">output_variables</span><span class="o">=</span><span class="n">ca_output_vars</span><span class="p">,</span>
                <span class="n">epics_config</span><span class="o">=</span><span class="n">ca_config</span><span class="p">,</span>
                <span class="n">in_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="p">,</span>
                <span class="n">out_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">[</span><span class="s2">&quot;ca&quot;</span><span class="p">],</span>
                <span class="n">running_indicator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span><span class="o">.</span><span class="n">exit_event</span><span class="p">)</span>

        <span class="c1"># initialize pvAccess server</span>
        <span class="k">if</span> <span class="s2">&quot;pva&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="n">pva_input_vars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
                <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">pva_config</span>
            <span class="p">}</span>
            <span class="n">pva_output_vars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
                <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">pva_config</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span> <span class="o">=</span> <span class="n">PVAServer</span><span class="p">(</span>
                <span class="n">input_variables</span><span class="o">=</span><span class="n">pva_input_vars</span><span class="p">,</span>
                <span class="n">output_variables</span><span class="o">=</span><span class="n">pva_output_vars</span><span class="p">,</span>
                <span class="n">epics_config</span><span class="o">=</span><span class="n">pva_config</span><span class="p">,</span>
                <span class="n">in_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="p">,</span>
                <span class="n">out_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">[</span><span class="s2">&quot;pva&quot;</span><span class="p">],</span>
                <span class="n">running_indicator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span><span class="o">.</span><span class="n">exit_event</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle server startup&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle server shutdown&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run_comm_thread</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">running_indicator</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span>
        <span class="n">in_queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">],</span>
        <span class="n">out_queues</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles communications between pvAccess server, Channel Access server, and</span>
<span class="sd">             dmodel.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            running_indicator (multiprocessing.Value): Indicates whether main server</span>
<span class="sd">                process active.</span>

<span class="sd">            in_queue (Optional[multiprocessing.Queue]): Queue receiving input variable</span>
<span class="sd">                inputs.</span>

<span class="sd">            out_queues (Optional[Dict[str, multiprocessing.Queue]]): Queue for communicating</span>
<span class="sd">                output vars with servers.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">inputs_initialized</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">in_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

                <span class="c1"># mark running</span>
                <span class="n">running_indicator</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span>

                <span class="c1"># check no input values are None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="p">):</span>
                    <span class="n">inputs_initialized</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># update output variable state</span>
                <span class="k">if</span> <span class="n">inputs_initialized</span><span class="p">:</span>

                    <span class="c1"># sync pva/ca if duplicated</span>
                    <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">out_queues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">protocol</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]:</span>
                            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span>
                                <span class="ow">in</span> <span class="p">[</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
                                <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;input_variables&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">})</span>

                    <span class="n">model_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">predicted_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">out_queues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span>
                                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">predicted_output</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pva_fields</span>
                                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span>
                                <span class="ow">in</span> <span class="p">[</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                            <span class="p">}</span>
                            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;output_variables&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_model_exec_exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="n">running_indicator</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">except</span> <span class="n">Full</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2"> queue is full.&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping execution thread&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts server using set server protocol(s).</span>

<span class="sd">        Args:</span>
<span class="sd">            monitor (bool): Indicates whether to run the server in the background or to</span>
<span class="sd">                continually monitor. If monitor = False, the server must be explicitly</span>
<span class="sd">                stopped using server.stop()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;ca&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;pva&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">monitor</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">exit_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">exit_event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span>
                        <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_exec_exit_event</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

                <span class="c1"># shut down server if process exited.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stops the server.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping server.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;ca&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;pva&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is stopped.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;pvname&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span><span class="p">,</span>
            <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span><span class="p">,</span>
            <span class="s2">&quot;date published&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_published</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">owner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary_pvname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">date_published</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_published</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_server.Server.__enter__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__enter__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Handle server startup</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle server startup&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_server.Server.__exit__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Handle server shutdown</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle server shutdown&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_server.Server.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">epics_config</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">epics_env</span><span class="o">=</span><span class="p">{})</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Create model_class instance and configure both Channel Access and pvAccess
servers for execution.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model_class</code></td>
          <td>
                <code><span title="typing.Type">Type</span>[<span title="lume_model.models.BaseModel">BaseModel</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model class to be instantiated</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>epics_config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary describing EPICS configuration for model
variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_kwargs</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Kwargs to instantiate model.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>epics_env</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Environment variables for EPICS configuration.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span>
    <span class="n">epics_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">model_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># TODO DROP and use instantiated mode</span>
    <span class="n">epics_env</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># TODO drop hashable default. Should be Optional[dict]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create model_class instance and configure both Channel Access and pvAccess</span>
<span class="sd">    servers for execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_class (Type[BaseModel]): Model class to be instantiated</span>

<span class="sd">        epics_config (dict): Dictionary describing EPICS configuration for model</span>
<span class="sd">            variables.</span>

<span class="sd">        model_kwargs (dict): Kwargs to instantiate model.</span>

<span class="sd">        epics_env (dict): Environment variables for EPICS configuration.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Update epics environment if programatically set</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">EPICS_ENV_VARS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">epics_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">epics_env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_variables</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span> <span class="o">=</span> <span class="n">epics_config</span>

    <span class="c1"># define programatic access to model summary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_date_published</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># If configured, set up summary pv</span>
    <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pvname&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_date_published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;date_published&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ca_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">pva_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pva&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
        <span class="ow">or</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span>
    <span class="p">}</span>

    <span class="c1"># track nested fields</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pva_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pva_fields</span> <span class="o">+=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ca_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ca&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pva_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pva&quot;</span><span class="p">)</span>

    <span class="c1"># set up protocol based queues</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="c1"># exit event for triggering shutdown</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># event for shutdown on model execution exceptions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_model_exec_exit_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

    <span class="c1"># we use the running marker to make sure pvs + ca don&#39;t just keep adding queue elements</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">comm_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_comm_thread</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;in_queue&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="p">,</span>
            <span class="s2">&quot;out_queues&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">,</span>
            <span class="s2">&quot;running_indicator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># initialize channel access server</span>
    <span class="k">if</span> <span class="s2">&quot;ca&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
        <span class="n">ca_input_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">ca_config</span>
        <span class="p">}</span>
        <span class="n">ca_output_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">ca_config</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span> <span class="o">=</span> <span class="n">CAServer</span><span class="p">(</span>
            <span class="n">input_variables</span><span class="o">=</span><span class="n">ca_input_vars</span><span class="p">,</span>
            <span class="n">output_variables</span><span class="o">=</span><span class="n">ca_output_vars</span><span class="p">,</span>
            <span class="n">epics_config</span><span class="o">=</span><span class="n">ca_config</span><span class="p">,</span>
            <span class="n">in_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="p">,</span>
            <span class="n">out_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">[</span><span class="s2">&quot;ca&quot;</span><span class="p">],</span>
            <span class="n">running_indicator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span><span class="o">.</span><span class="n">exit_event</span><span class="p">)</span>

    <span class="c1"># initialize pvAccess server</span>
    <span class="k">if</span> <span class="s2">&quot;pva&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
        <span class="n">pva_input_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">pva_config</span>
        <span class="p">}</span>
        <span class="n">pva_output_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">var</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">pva_config</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span> <span class="o">=</span> <span class="n">PVAServer</span><span class="p">(</span>
            <span class="n">input_variables</span><span class="o">=</span><span class="n">pva_input_vars</span><span class="p">,</span>
            <span class="n">output_variables</span><span class="o">=</span><span class="n">pva_output_vars</span><span class="p">,</span>
            <span class="n">epics_config</span><span class="o">=</span><span class="n">pva_config</span><span class="p">,</span>
            <span class="n">in_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_queue</span><span class="p">,</span>
            <span class="n">out_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_queues</span><span class="p">[</span><span class="s2">&quot;pva&quot;</span><span class="p">],</span>
            <span class="n">running_indicator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span><span class="o">.</span><span class="n">exit_event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_server.Server.run_comm_thread" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_comm_thread</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">running_indicator</span><span class="p">,</span> <span class="n">in_queue</span><span class="p">,</span> <span class="n">out_queues</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Handles communications between pvAccess server, Channel Access server, and
     dmodel.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>running_indicator</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Value">Value</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Indicates whether main server
process active.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>in_queue</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[multiprocessing.<span title="multiprocessing.Queue">Queue</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue receiving input variable
inputs.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>out_queues</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[str, multiprocessing.<span title="multiprocessing.Queue">Queue</span>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue for communicating
output vars with servers.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_comm_thread</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">running_indicator</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span>
    <span class="n">in_queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">],</span>
    <span class="n">out_queues</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles communications between pvAccess server, Channel Access server, and</span>
<span class="sd">         dmodel.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        running_indicator (multiprocessing.Value): Indicates whether main server</span>
<span class="sd">            process active.</span>

<span class="sd">        in_queue (Optional[multiprocessing.Queue]): Queue receiving input variable</span>
<span class="sd">            inputs.</span>

<span class="sd">        out_queues (Optional[Dict[str, multiprocessing.Queue]]): Queue for communicating</span>
<span class="sd">            output vars with servers.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
    <span class="n">inputs_initialized</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">in_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="c1"># mark running</span>
            <span class="n">running_indicator</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span>

            <span class="c1"># check no input values are None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="p">):</span>
                <span class="n">inputs_initialized</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># update output variable state</span>
            <span class="k">if</span> <span class="n">inputs_initialized</span><span class="p">:</span>

                <span class="c1"># sync pva/ca if duplicated</span>
                <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">out_queues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">protocol</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;protocol&quot;</span><span class="p">]:</span>
                        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vars&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span>
                            <span class="ow">in</span> <span class="p">[</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                        <span class="p">}</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
                            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;input_variables&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">})</span>

                <span class="n">model_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_variables</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">predicted_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">queue</span> <span class="ow">in</span> <span class="n">out_queues</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span>
                            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">predicted_output</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pva_fields</span>
                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;protocol&quot;</span><span class="p">]</span>
                            <span class="ow">in</span> <span class="p">[</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">]</span>
                        <span class="p">}</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;output_variables&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model_exec_exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="n">running_indicator</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">except</span> <span class="n">Full</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2"> queue is full.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping execution thread&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_server.Server.start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Starts server using set server protocol(s).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>monitor</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Indicates whether to run the server in the background or to
continually monitor. If monitor = False, the server must be explicitly
stopped using server.stop()</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Starts server using set server protocol(s).</span>

<span class="sd">    Args:</span>
<span class="sd">        monitor (bool): Indicates whether to run the server in the background or to</span>
<span class="sd">            continually monitor. If monitor = False, the server must be explicitly</span>
<span class="sd">            stopped using server.stop()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">comm_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;ca&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;pva&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">monitor</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">exit_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">exit_event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_exit_events</span>
                    <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_exec_exit_event</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="c1"># shut down server if process exited.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_server.Server.stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Stops the server.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stops the server.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping server.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">comm_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;ca&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca_process</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;pva&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pva_process</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is stopped.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="lume_epics.epics_ca_server"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="lume_epics.epics_ca_server.CADriver" class="doc doc-heading">
        <code>CADriver</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="pcaspy.Driver">Driver</span></code></p>

  
      <p>Class for handling read and write requests to Channel Access process variables.</p>


        <details class="quote">
          <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CADriver</span><span class="p">(</span><span class="n">Driver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for handling read and write requests to Channel Access process variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Channel Access driver. Store input state and output state.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CADriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method executed by server when clients read a Channel Access process</span>
<span class="sd">        variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            pvname (str): Process variable name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method executed by server when clients write to a Channel Access process</span>
<span class="sd">        variable.</span>


<span class="sd">        Args:</span>
<span class="sd">            pvname (str): Process variable name.</span>

<span class="sd">            value (Union[float, np.ndarray]): Value to assign to the process variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># handle area detector types</span>
        <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pvname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">:</span>
            <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">model_var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_output_variables</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Cannot update variable </span><span class="si">%s</span><span class="s2">. Output variables can only be updated via surrogate model callback.&quot;</span><span class="p">,</span>
                <span class="n">pvname</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;None value provided for </span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">model_var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">model_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">is_constant</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to update constant variable </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_var_name</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatePVs</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Channel Access process variable </span><span class="si">%s</span><span class="s2"> updated with value </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">pvname</span><span class="p">,</span>
                    <span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_pv</span><span class="p">(</span><span class="n">pvname</span><span class="o">=</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in server variables.&quot;</span><span class="p">,</span> <span class="n">pvname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">update_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Variable</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update output Channel Access process variables after model execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            variables (List[Variable]): List of variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_input_variables</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">is_constant</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot update constant variable </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pvname</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Channel Access image process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span>
                        <span class="n">pvname</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:ArrayData_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MinX_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MinY_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MaxX_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MaxY_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Channel Access process variable </span><span class="si">%s</span><span class="s2"> updated wth value </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                        <span class="n">pvname</span><span class="p">,</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Channel Access image process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span>
                        <span class="n">pvname</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:ArrayData_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;No instructions for handling variable </span><span class="si">%s</span><span class="s2"> of type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updatePVs</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CADriver.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">server</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the Channel Access driver. Store input state and output state.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Channel Access driver. Store input state and output state.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">CADriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CADriver.read" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Method executed by server when clients read a Channel Access process
variable.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pvname</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Process variable name.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Method executed by server when clients read a Channel Access process</span>
<span class="sd">    variable.</span>

<span class="sd">    Args:</span>
<span class="sd">        pvname (str): Process variable name.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getParam</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CADriver.update_pvs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_pvs</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update output Channel Access process variables after model execution.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>variables</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="lume_model.variables.Variable">Variable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_pvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Variable</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update output Channel Access process variables after model execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        variables (List[Variable]): List of variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_input_variables</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">is_constant</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Cannot update constant variable </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pvname</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Channel Access image process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span>
                    <span class="n">pvname</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:ArrayData_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MinX_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MinY_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MaxX_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:MaxY_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Channel Access process variable </span><span class="si">%s</span><span class="s2"> updated wth value </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="n">pvname</span><span class="p">,</span>
                    <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Channel Access image process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span>
                    <span class="n">pvname</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span> <span class="o">+</span> <span class="s2">&quot;:ArrayData_RBV&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;No instructions for handling variable </span><span class="si">%s</span><span class="s2"> of type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">updatePVs</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CADriver.write" class="doc doc-heading">
<code class="highlight language-python"><span class="n">write</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Method executed by server when clients write to a Channel Access process
variable.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pvname</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Process variable name.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>value</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[float, <span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Value to assign to the process variable.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Method executed by server when clients write to a Channel Access process</span>
<span class="sd">    variable.</span>


<span class="sd">    Args:</span>
<span class="sd">        pvname (str): Process variable name.</span>

<span class="sd">        value (Union[float, np.ndarray]): Value to assign to the process variable.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># handle area detector types</span>
    <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pvname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">:</span>
        <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">model_var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_output_variables</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Cannot update variable </span><span class="si">%s</span><span class="s2">. Output variables can only be updated via surrogate model callback.&quot;</span><span class="p">,</span>
            <span class="n">pvname</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;None value provided for </span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">model_var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">model_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">is_constant</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to update constant variable </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_var_name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setParam</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatePVs</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Channel Access process variable </span><span class="si">%s</span><span class="s2"> updated with value </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">pvname</span><span class="p">,</span>
                <span class="n">value</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_pv</span><span class="p">(</span><span class="n">pvname</span><span class="o">=</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in server variables.&quot;</span><span class="p">,</span> <span class="n">pvname</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="lume_epics.epics_ca_server.CAServer" class="doc doc-heading">
        <code>CAServer</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="epics.multiproc.CAProcess">CAProcess</span></code></p>

  
      <p>Process-based implementation of Channel Access server.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>_ca_server</code></td>
          <td>
                <code><span title="pcaspy.SimpleServer">SimpleServer</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pcaspy SimpleServer instance</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_ca_driver</code></td>
          <td>
                <code><span title="pcaspy.Driver">Driver</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pcaspy Driver instance</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_input_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.InputVariable">InputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mapping of input variable name to variable</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_output_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.InputVariable">InputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mapping of output variable name to variable</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_server_thread</code></td>
          <td>
                <code>ServerThread</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Thread for running the server</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>shutdown_event</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Event">Event</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Event indicating shutdown</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>exit_event</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Event">Event</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Event indicating early exit</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_running_indicator</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Value">Value</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Value indicating whether model execution ongoing</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_epics_config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary describing EPICS configuration for model variables</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_in_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue for pushing updated input variables to model execution</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_out_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Process model output variables and sync with pvAccess server</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CAServer</span><span class="p">(</span><span class="n">CAProcess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process-based implementation of Channel Access server.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _ca_server (SimpleServer): pcaspy SimpleServer instance</span>

<span class="sd">        _ca_driver (Driver): pcaspy Driver instance</span>

<span class="sd">        _input_variables (Dict[str, InputVariable]): Mapping of input variable name to variable</span>

<span class="sd">        _output_variables (Dict[str, InputVariable]): Mapping of output variable name to variable</span>

<span class="sd">        _server_thread (ServerThread): Thread for running the server</span>

<span class="sd">        shutdown_event (multiprocessing.Event): Event indicating shutdown</span>

<span class="sd">        exit_event (multiprocessing.Event): Event indicating early exit</span>

<span class="sd">        _running_indicator (multiprocessing.Value): Value indicating whether model execution ongoing</span>

<span class="sd">        _epics_config (dict): Dictionary describing EPICS configuration for model variables</span>

<span class="sd">        _in_queue (multiprocessing.Queue): Queue for pushing updated input variables to model execution</span>

<span class="sd">        _out_queue (multiprocessing.Queue): Process model output variables and sync with pvAccess server</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;ca&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InputVariable</span><span class="p">],</span>
        <span class="n">output_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OutputVariable</span><span class="p">],</span>
        <span class="n">epics_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">in_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">out_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">running_indicator</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize server process.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_variables (Dict[str, InputVariable]): Dictionary mapping pvname to lume-model input variable.</span>
<span class="sd">            output_variables (Dict[str, OutputVariable]):Dictionary mapping pvname to lume-model output variable.</span>
<span class="sd">            epics_config (dict): Dictionary mapping pvname to EPICS configuration.</span>
<span class="sd">            in_queue (multiprocessing.Queue): Queue for tracking updates to input variables.</span>
<span class="sd">            out_queue (multiprocessing.Queue): Queue for tracking updates to output variables.</span>
<span class="sd">            running_indicator (multiprocessing.Value): Multiprocessing value for indicating if server running.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span> <span class="o">=</span> <span class="n">input_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span> <span class="o">=</span> <span class="n">output_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span> <span class="o">=</span> <span class="n">in_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span> <span class="o">=</span> <span class="n">out_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span> <span class="o">=</span> <span class="n">running_indicator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span> <span class="o">=</span> <span class="n">epics_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># utility maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]:</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># cached pv values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">update_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds update to input process variable to the input queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            pvname (str): Name of process variable</span>

<span class="sd">            value (Union[np.ndarray, float]): Value to set</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pvname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">:</span>
            <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

        <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">model_var_name</span><span class="p">]</span>

        <span class="c1"># check for already cached variable</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_var_name</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>

        <span class="c1"># check for image variable and proper assignments</span>
        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>

            <span class="n">attr_type</span> <span class="o">=</span> <span class="n">pvname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;ArrayData_RBV&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MinX_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MinY_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MaxX_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MaxY_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># assign value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">[</span><span class="n">model_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>

        <span class="c1"># only update if not running</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_monitor_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback executed on value change events.&quot;&quot;&quot;</span>
        <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>

        <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_var_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variable</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_var_name</span><span class="p">)</span>

        <span class="c1"># check for already cached variable</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_var_name</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>

        <span class="c1"># check for image variable and proper assignments</span>
        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>

            <span class="n">attr_type</span> <span class="o">=</span> <span class="n">pvname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;ArrayData_RBV&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MinX_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MinY_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">y_mix</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MaxX_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MaxY_RBV&quot;</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># assign value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">[</span><span class="n">model_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>

        <span class="c1"># only update if not running</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize model&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">setup_server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure and start server.&quot;&quot;&quot;</span>
        <span class="c1"># ignore interrupt in subprocess</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing CA server&quot;</span><span class="p">)</span>

        <span class="c1"># update value with stored defaults</span>
        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span>
                    <span class="n">var_name</span>
                <span class="p">]</span><span class="o">.</span><span class="n">default</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">epics</span><span class="o">.</span><span class="n">caget</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to connect to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># initialize channel access server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span> <span class="o">=</span> <span class="n">SimpleServer</span><span class="p">()</span>

        <span class="c1"># update output variable values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_model</span><span class="p">()</span>
        <span class="n">model_outputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="n">model_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">pass</span>

        <span class="n">model_output_vars</span> <span class="o">=</span> <span class="n">model_outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_output_vars</span><span class="p">)</span>

        <span class="c1"># differentiate between values to serve and not to serve</span>
        <span class="n">to_serve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">external</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">)</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
                    <span class="n">to_serve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">external</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="c1"># build pvdb and child to parent map for area detector scheme</span>
        <span class="n">pvdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_to_parent_map</span> <span class="o">=</span> <span class="n">build_pvdb</span><span class="p">(</span>
            <span class="p">[</span><span class="n">variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">to_serve</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span>
        <span class="p">)</span>

        <span class="c1"># for external variables create monitors</span>
        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">external</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">epics</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">get_pv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_callback</span><span class="p">)</span>

        <span class="c1"># Register pvs with server if serving</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvdb</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span><span class="o">.</span><span class="n">createPV</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pvdb</span><span class="p">)</span>

            <span class="c1"># set up driver for handing read and write requests to process variables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span> <span class="o">=</span> <span class="n">CADriver</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># start the server thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">CAServerThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CA server started&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">update_pvs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InputVariable</span><span class="p">],</span>
        <span class="n">output_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OutputVariable</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update process variables over Channel Access.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_variables (Dict[str, InputVariable]): List of lume-epics output variables.</span>

<span class="sd">            output_variables (Dict[str, OutputVariable]): List of lume-model output variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">input_variables</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output_variables</span><span class="p">)</span>

        <span class="c1"># update variables if the driver is running</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span><span class="o">.</span><span class="n">update_pvs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start server process.&quot;&quot;&quot;</span>
        <span class="n">started</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_server</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">started</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_pvs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;out queue empty&quot;</span><span class="p">)</span>

            <span class="c1"># if server thread running</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Channel access server stopped.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to set up server. Shutting down.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely shutdown the server process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">input_variables</span><span class="p">,</span> <span class="n">output_variables</span><span class="p">,</span> <span class="n">epics_config</span><span class="p">,</span> <span class="n">in_queue</span><span class="p">,</span> <span class="n">out_queue</span><span class="p">,</span> <span class="n">running_indicator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize server process.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.InputVariable">InputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary mapping pvname to lume-model input variable.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.OutputVariable">OutputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary mapping pvname to lume-model output variable.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>epics_config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary mapping pvname to EPICS configuration.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>in_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue for tracking updates to input variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>out_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue for tracking updates to output variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>running_indicator</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Value">Value</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Multiprocessing value for indicating if server running.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InputVariable</span><span class="p">],</span>
    <span class="n">output_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OutputVariable</span><span class="p">],</span>
    <span class="n">epics_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">in_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
    <span class="n">out_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
    <span class="n">running_indicator</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize server process.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_variables (Dict[str, InputVariable]): Dictionary mapping pvname to lume-model input variable.</span>
<span class="sd">        output_variables (Dict[str, OutputVariable]):Dictionary mapping pvname to lume-model output variable.</span>
<span class="sd">        epics_config (dict): Dictionary mapping pvname to EPICS configuration.</span>
<span class="sd">        in_queue (multiprocessing.Queue): Queue for tracking updates to input variables.</span>
<span class="sd">        out_queue (multiprocessing.Queue): Queue for tracking updates to output variables.</span>
<span class="sd">        running_indicator (multiprocessing.Value): Multiprocessing value for indicating if server running.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span> <span class="o">=</span> <span class="n">input_variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span> <span class="o">=</span> <span class="n">output_variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span> <span class="o">=</span> <span class="n">in_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span> <span class="o">=</span> <span class="n">out_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span> <span class="o">=</span> <span class="n">running_indicator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span> <span class="o">=</span> <span class="n">epics_config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="c1"># utility maps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]:</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1"># cached pv values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServer.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Start server process.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start server process.&quot;&quot;&quot;</span>
    <span class="n">started</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_server</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">started</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_pvs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;out queue empty&quot;</span><span class="p">)</span>

        <span class="c1"># if server thread running</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Channel access server stopped.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to set up server. Shutting down.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServer.setup_server" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setup_server</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Configure and start server.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup_server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure and start server.&quot;&quot;&quot;</span>
    <span class="c1"># ignore interrupt in subprocess</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing CA server&quot;</span><span class="p">)</span>

    <span class="c1"># update value with stored defaults</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span>
                <span class="n">var_name</span>
            <span class="p">]</span><span class="o">.</span><span class="n">default</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">epics</span><span class="o">.</span><span class="n">caget</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to connect to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># initialize channel access server</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span> <span class="o">=</span> <span class="n">SimpleServer</span><span class="p">()</span>

    <span class="c1"># update output variable values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_model</span><span class="p">()</span>
    <span class="n">model_outputs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="n">model_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="n">model_output_vars</span> <span class="o">=</span> <span class="n">model_outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_output_vars</span><span class="p">)</span>

    <span class="c1"># differentiate between values to serve and not to serve</span>
    <span class="n">to_serve</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">external</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">)</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
                <span class="n">to_serve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">external</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="c1"># build pvdb and child to parent map for area detector scheme</span>
    <span class="n">pvdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_to_parent_map</span> <span class="o">=</span> <span class="n">build_pvdb</span><span class="p">(</span>
        <span class="p">[</span><span class="n">variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">to_serve</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span>
    <span class="p">)</span>

    <span class="c1"># for external variables create monitors</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">external</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">epics</span><span class="o">.</span><span class="n">pv</span><span class="o">.</span><span class="n">get_pv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_callback</span><span class="p">)</span>

    <span class="c1"># Register pvs with server if serving</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvdb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span><span class="o">.</span><span class="n">createPV</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pvdb</span><span class="p">)</span>

        <span class="c1"># set up driver for handing read and write requests to process variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span> <span class="o">=</span> <span class="n">CADriver</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># start the server thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">CAServerThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ca_server</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CA server started&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServer.shutdown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shutdown</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Safely shutdown the server process.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely shutdown the server process.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServer.update_pv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_pv</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Adds update to input process variable to the input queue.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pvname</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Name of process variable</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>value</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, float]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Value to set</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds update to input process variable to the input queue.</span>

<span class="sd">    Args:</span>
<span class="sd">        pvname (str): Name of process variable</span>

<span class="sd">        value (Union[np.ndarray, float]): Value to set</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pvname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pvname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">:</span>
        <span class="n">model_var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_to_parent_map</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

    <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">model_var_name</span><span class="p">]</span>

    <span class="c1"># check for already cached variable</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_var_name</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>

    <span class="c1"># check for image variable and proper assignments</span>
    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>

        <span class="n">attr_type</span> <span class="o">=</span> <span class="n">pvname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;ArrayData_RBV&quot;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MinX_RBV&quot;</span><span class="p">:</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MinY_RBV&quot;</span><span class="p">:</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MaxX_RBV&quot;</span><span class="p">:</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">attr_type</span> <span class="o">==</span> <span class="s2">&quot;MaxY_RBV&quot;</span><span class="p">:</span>
            <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># assign value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">[</span><span class="n">model_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>

    <span class="c1"># only update if not running</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;ca&quot;</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServer.update_pvs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_pvs</span><span class="p">(</span><span class="n">input_variables</span><span class="p">,</span> <span class="n">output_variables</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update process variables over Channel Access.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.InputVariable">InputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of lume-epics output variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.OutputVariable">OutputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of lume-model output variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_pvs</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InputVariable</span><span class="p">],</span>
    <span class="n">output_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OutputVariable</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update process variables over Channel Access.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_variables (Dict[str, InputVariable]): List of lume-epics output variables.</span>

<span class="sd">        output_variables (Dict[str, OutputVariable]): List of lume-model output variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">input_variables</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output_variables</span><span class="p">)</span>

    <span class="c1"># update variables if the driver is running</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ca_driver</span><span class="o">.</span><span class="n">update_pvs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="lume_epics.epics_ca_server.CAServerThread" class="doc doc-heading">
        <code>CAServerThread</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="epics.ca.CAThread">CAThread</span></code></p>

  
      <p>A helper class to run server in a thread.</p>


        <details class="quote">
          <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CAServerThread</span><span class="p">(</span><span class="n">CAThread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper class to run server in a thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            server (pcaspy.SimpleServer): Pcaspy server to run in thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CAThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the server processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the server processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServerThread.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">server</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>server</code></td>
          <td>
                <code>pcaspy.<span title="pcaspy.SimpleServer">SimpleServer</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Pcaspy server to run in thread.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        server (pcaspy.SimpleServer): Pcaspy server to run in thread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">CAThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServerThread.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Start the server processing</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the server processing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_ca_server.CAServerThread.stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Stop the server processing</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stop the server processing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="lume_epics.epics_ca_server.build_pvdb" class="doc doc-heading">
<code class="highlight language-python"><span class="n">build_pvdb</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">epics_config</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Utility function for building dictionary (pvdb) used to initialize the channel
access server.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>variables</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="lume_model.variables.Variable">Variable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of lume_model variables to be served with
channel access server.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>epics_config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Epics pvnames for each variable</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td></td>          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>pvdb (dict)</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>child_to_parent_map</code></td>          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mapping of child pvs to parent model variables</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_ca_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_pvdb</span><span class="p">(</span><span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Variable</span><span class="p">],</span> <span class="n">epics_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function for building dictionary (pvdb) used to initialize the channel</span>
<span class="sd">    access server.</span>

<span class="sd">    Args:</span>
<span class="sd">        variables (List[Variable]): List of lume_model variables to be served with</span>
<span class="sd">            channel access server.</span>

<span class="sd">        epics_config (dict): Epics pvnames for each variable</span>

<span class="sd">    Returns:</span>
<span class="sd">        pvdb (dict)</span>
<span class="sd">        child_to_parent_map (dict): Mapping of child pvs to parent model variables</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pvdb</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">child_to_parent_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">pvname</span> <span class="o">=</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">array_size_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">array_size_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">array_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">array_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ndim</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">array_size_x</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">array_size_y</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">array_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">array_data</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

            <span class="c1"># infer color mode</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">color_mode</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">color_mode</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Color mode cannot be inferred from image shape </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
                <span class="n">color_mode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># assign default PVS</span>
            <span class="n">pvdb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:NDimensions_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;prec&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">ndim</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:Dimensions_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;prec&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">ndim</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">shape</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArraySizeX_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">array_size_x</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArraySizeY_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">array_size_y</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArraySize_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">array_size</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArrayData_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;prec&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">array_data</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:MinX_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:MinY_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:MaxX_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:MaxY_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ColorMode_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">color_mode</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="n">child_to_parent_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;NDimensions_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Dimensions_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ArraySizeX_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ArraySizeY_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ArraySize_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ArrayData_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MinX_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MinY_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MaxX_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MaxY_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ColorMode_RBV&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">__fields_set__</span><span class="p">:</span>
                <span class="n">pvdb</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArrayData_RBV&quot;</span><span class="p">][</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">units</span>

            <span class="c1"># handle rgb arrays</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pvdb</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArraySizeZ_RBV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">}</span>

        <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
            <span class="n">pvdb</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">by_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pvdb</span><span class="p">[</span><span class="n">pvname</span><span class="p">][</span><span class="s2">&quot;hilim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pvdb</span><span class="p">[</span><span class="n">pvname</span><span class="p">][</span><span class="s2">&quot;lolim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pvdb</span><span class="p">[</span><span class="n">pvname</span><span class="p">][</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">units</span>

        <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>

            <span class="c1"># assign default PVS</span>
            <span class="n">pvdb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:NDimensions_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;prec&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:Dimensions_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;prec&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArrayData_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_type</span><span class="p">,</span>
                        <span class="s2">&quot;prec&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span>
                        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArraySize_RBV&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)),</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="n">child_to_parent_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;NDimensions_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Dimensions_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ArraySize_RBV&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ArrayData_RBV&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">__fields_set__</span><span class="p">:</span>
                <span class="n">pvdb</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pvname</span><span class="si">}</span><span class="s2">:ArrayData_RBV&quot;</span><span class="p">][</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">units</span>

    <span class="k">return</span> <span class="n">pvdb</span><span class="p">,</span> <span class="n">child_to_parent_map</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="lume_epics.epics_pva_server"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="lume_epics.epics_pva_server.PVAServer" class="doc doc-heading">
        <code>PVAServer</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>multiprocessing.<span title="multiprocessing.Process">Process</span></code></p>

  
      <p>Process-based implementation of Channel Access server.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pva_server</code></td>
          <td>
                <code><span title="p4p.server.Server">P4PServer</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>p4p server instance</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>exit_event</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Event">Event</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Event indicating pvAccess server error and communicating to main</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>shutdown_event</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Event">Event</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Event indicating shutdown</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_input_variables</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="lume_model.variables.InputVariable">InputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of input variables</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_output_variables</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="lume_model.variables.OutputVariable">OutputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of output variables</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_in_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>input variable queue</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_out_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>output variable update queue</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_providers</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary mapping pvname to p4p provider</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_running_indicator</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Value">Value</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Boolean indicator of running model execution</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_monitors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of monitor objects for read-only server</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_cached_values</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dict for caching values while model executes</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_pvname_to_varname_map</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mapping of pvname to variable name</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>_varname_to_pvname_map</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mapping of variable name to pvame</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PVAServer</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process-based implementation of Channel Access server.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pva_server (P4PServer): p4p server instance</span>
<span class="sd">        exit_event (multiprocessing.Event): Event indicating pvAccess server error and communicating to main</span>
<span class="sd">        shutdown_event (multiprocessing.Event): Event indicating shutdown</span>
<span class="sd">        _input_variables (List[InputVariable]): List of input variables</span>
<span class="sd">        _output_variables (List[OutputVariable]): List of output variables</span>
<span class="sd">        _in_queue (multiprocessing.Queue): input variable queue</span>
<span class="sd">        _out_queue (multiprocessing.Queue): output variable update queue</span>
<span class="sd">        _providers (dict): Dictionary mapping pvname to p4p provider</span>
<span class="sd">        _running_indicator (multiprocessing.Value): Boolean indicator of running model execution</span>
<span class="sd">        _monitors (dict): Dictionary of monitor objects for read-only server</span>
<span class="sd">        _cached_values (dict): Dict for caching values while model executes</span>
<span class="sd">        _pvname_to_varname_map (dict): Mapping of pvname to variable name</span>
<span class="sd">        _varname_to_pvname_map (dict): Mapping of variable name to pvame</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;pva&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InputVariable</span><span class="p">],</span>
        <span class="n">output_variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputVariable</span><span class="p">],</span>
        <span class="n">epics_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">in_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">out_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">running_indicator</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize server process.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_variables (Dict[str, InputVariable]): Dictionary mapping pvname to lume-model input variable.</span>

<span class="sd">            output_variables (Dict[str, OutputVariable]):Dictionary mapping pvname to lume-model output variable.</span>

<span class="sd">            epics_config (dict): Dictionary describing EPICS configuration for model variables</span>

<span class="sd">            in_queue (multiprocessing.Queue): Queue for tracking updates to input variables</span>

<span class="sd">            out_queue (multiprocessing.Queue): Queue for tracking updates to output variables</span>

<span class="sd">            running_indicator (multiprocessing.Value): Boolean indicator indicating running model execution</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span> <span class="o">=</span> <span class="n">input_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span> <span class="o">=</span> <span class="n">output_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span> <span class="o">=</span> <span class="n">epics_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span> <span class="o">=</span> <span class="n">in_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span> <span class="o">=</span> <span class="n">out_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span> <span class="o">=</span> <span class="n">running_indicator</span>
        <span class="c1"># monitors for read only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_parent_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># utility maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]:</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds update to input process variable to the input queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            pvname (str): Name of process variable</span>

<span class="sd">            value (Union[np.ndarray, float]): Value to set</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Hack for now to get the pickable value</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">value</span>

        <span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>
        <span class="n">model_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>

        <span class="c1"># check for already cached variable</span>
        <span class="n">model_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">model_variable</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">y_min</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_variable</span>

        <span class="c1"># only update if not running</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_monitor_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback function used for updating read_only process variables.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">value</span>
        <span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>
        <span class="n">model_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_variable</span><span class="p">:</span>
            <span class="n">model_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>

        <span class="c1"># check for already cached variable</span>
        <span class="n">model_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">model_variable</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">y_min</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span>
            <span class="n">model_variable</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_variable</span>

        <span class="c1"># only update if not running</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize model&quot;&quot;&quot;</span>

        <span class="n">rep</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;pva&quot;</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure and start server.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>

        <span class="c1"># update value with stored defaults</span>
        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span>
                    <span class="n">var_name</span>
                <span class="p">]</span><span class="o">.</span><span class="n">default</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;pva&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">])</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">value</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to connect to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># update output variable values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_model</span><span class="p">()</span>
        <span class="n">model_outputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="n">model_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">pass</span>

        <span class="c1"># if startup hasn&#39;t failed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_output_vars</span> <span class="o">=</span> <span class="n">model_outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_output_vars</span><span class="p">)</span>

            <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">)</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="p">)</span>

            <span class="c1"># ignore interrupt in subprocess</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing pvAccess server&quot;</span><span class="p">)</span>

            <span class="c1"># initialize global inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_structure_specs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
                    <span class="n">fields</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">)</span>
                    <span class="n">pvname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pvname&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">spec</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">structure</span> <span class="o">=</span> <span class="p">{}</span>

                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                            <span class="c1"># track fields in dict</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_parent_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_name</span>

                            <span class="n">variable</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

                            <span class="k">if</span> <span class="n">variable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> not found in variable list&quot;</span>
                                <span class="p">)</span>

                            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
                                <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">))</span>
                                <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
                                <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
                                <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">))</span>
                                <span class="n">table_rep</span> <span class="o">=</span> <span class="p">()</span>
                                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                    <span class="c1"># here we assume double type in tables...</span>
                                    <span class="n">table_rep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;ad&quot;</span><span class="p">)</span>

                                <span class="n">nt</span> <span class="o">=</span> <span class="n">NTTable</span><span class="p">(</span><span class="n">table_rep</span><span class="p">)</span>
                                <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                                <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">))</span>

                                <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
                                    <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
                                    <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                                    <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                                    <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">nd_array</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                                <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">))</span>

                                <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                                <span class="n">nd_array</span><span class="o">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                                    <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                                    <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                                    <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                                <span class="p">}</span>

                                <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                                <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">nd_array</span><span class="p">)</span>

                            <span class="n">structure</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial</span>

                        <span class="c1"># assemble pv</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_structure_specs</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
                        <span class="n">struct_type</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
                        <span class="n">struct_value</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">struct_type</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
                        <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">struct_value</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">variable</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span>
                        <span class="c1"># prepare scalar variable types</span>
                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                        <span class="c1"># prepare image variable types</span>
                        <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                            <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                            <span class="n">nd_array</span><span class="o">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                                <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                                <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                                <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                            <span class="p">}</span>
                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">nd_array</span>

                        <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
                            <span class="n">table_rep</span> <span class="o">=</span> <span class="p">()</span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                <span class="c1"># here we assume double type in tables...</span>
                                <span class="n">table_rep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;ad&quot;</span><span class="p">)</span>

                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTTable</span><span class="p">(</span><span class="n">table_rep</span><span class="p">)</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
                                <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;as&quot;</span><span class="p">)</span>
                                <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                                <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                                <span class="n">initial</span> <span class="o">=</span> <span class="n">nd_array</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;Unsupported variable type provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span><span class="p">,</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
                            <span class="n">handler</span> <span class="o">=</span> <span class="n">PVAccessInputHandler</span><span class="p">(</span>
                                <span class="n">pvname</span><span class="o">=</span><span class="n">pvname</span><span class="p">,</span>
                                <span class="n">is_constant</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">is_constant</span><span class="p">,</span>
                                <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                            <span class="p">)</span>

                            <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">nt</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span>

                <span class="c1"># if not serving pv, set up monitor</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span>
                            <span class="n">pvname</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_callback</span><span class="p">,</span> <span class="n">pvname</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># in this case, externally hosted output variable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">:</span>
                <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pvname&quot;</span><span class="p">)</span>
                <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">)</span>
                <span class="n">date_published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_published&quot;</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;date_published&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;input_variables&quot;</span><span class="p">,</span> <span class="s2">&quot;as&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="s2">&quot;as&quot;</span><span class="p">),</span>
                <span class="p">]</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span>
                    <span class="s2">&quot;date_published&quot;</span><span class="p">:</span> <span class="n">date_published</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">owner</span><span class="p">,</span>
                    <span class="s2">&quot;input_variables&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;output_variables&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span>
                    <span class="p">],</span>
                <span class="p">}</span>

                <span class="n">pv_type</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">pv_type</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span>

            <span class="c1"># initialize pva server</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span> <span class="o">=</span> <span class="n">P4PServer</span><span class="p">(</span><span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">])</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pvAccess server started&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_pvs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InputVariable</span><span class="p">],</span>
        <span class="n">output_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OutputVariable</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update process variables over pvAccess.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_variables (Dict[str, InputVariable]): Dict of lume-epics output variables.</span>

<span class="sd">            output_variables (Dict[str, OutputVariable]): Dict of lume-model output variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">input_variables</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output_variables</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_parent_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">is_constant</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot update constant variable.&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;pvAccess image process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                    <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>

                    <span class="c1"># get dw and dh from model output</span>
                    <span class="n">nd_array</span><span class="o">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                        <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                        <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                        <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">nd_array</span>

                <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;pvAccess array process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>

                <span class="c1"># do not build attribute pvs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;pvAccess process variable </span><span class="si">%s</span><span class="s2"> updated with value </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># update structure or pv</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">struct_type</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure_specs</span><span class="p">[</span><span class="n">parent</span><span class="p">])</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">struct_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span><span class="p">[</span><span class="n">parent</span><span class="p">])</span>
                <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                <span class="n">output_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">output_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">output_provider</span><span class="p">:</span>
                <span class="n">output_provider</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># in this case externally hosted</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start server process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_server</span><span class="p">()</span>

        <span class="c1"># mark running</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_pvs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

                <span class="c1"># check cached values</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">}</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;out queue empty&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pvAccess server stopped.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely shutdown the server process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAServer.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">input_variables</span><span class="p">,</span> <span class="n">output_variables</span><span class="p">,</span> <span class="n">epics_config</span><span class="p">,</span> <span class="n">in_queue</span><span class="p">,</span> <span class="n">out_queue</span><span class="p">,</span> <span class="n">running_indicator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize server process.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.InputVariable">InputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary mapping pvname to lume-model input variable.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.OutputVariable">OutputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary mapping pvname to lume-model output variable.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>epics_config</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary describing EPICS configuration for model variables</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>in_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue for tracking updates to input variables</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>out_queue</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Queue">Queue</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Queue for tracking updates to output variables</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>running_indicator</code></td>
          <td>
                <code>multiprocessing.<span title="multiprocessing.Value">Value</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Boolean indicator indicating running model execution</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InputVariable</span><span class="p">],</span>
    <span class="n">output_variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputVariable</span><span class="p">],</span>
    <span class="n">epics_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">in_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
    <span class="n">out_queue</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
    <span class="n">running_indicator</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize server process.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_variables (Dict[str, InputVariable]): Dictionary mapping pvname to lume-model input variable.</span>

<span class="sd">        output_variables (Dict[str, OutputVariable]):Dictionary mapping pvname to lume-model output variable.</span>

<span class="sd">        epics_config (dict): Dictionary describing EPICS configuration for model variables</span>

<span class="sd">        in_queue (multiprocessing.Queue): Queue for tracking updates to input variables</span>

<span class="sd">        out_queue (multiprocessing.Queue): Queue for tracking updates to output variables</span>

<span class="sd">        running_indicator (multiprocessing.Value): Boolean indicator indicating running model execution</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span> <span class="o">=</span> <span class="n">input_variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span> <span class="o">=</span> <span class="n">output_variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span> <span class="o">=</span> <span class="n">epics_config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span> <span class="o">=</span> <span class="n">in_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span> <span class="o">=</span> <span class="n">out_queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span> <span class="o">=</span> <span class="n">running_indicator</span>
    <span class="c1"># monitors for read only</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_parent_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># utility maps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]:</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAServer.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Start server process.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start server process.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setup_server</span><span class="p">()</span>

    <span class="c1"># mark running</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_pvs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

            <span class="c1"># check cached values</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">}</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;out queue empty&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pvAccess server stopped.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAServer.setup_server" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setup_server</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Configure and start server.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup_server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure and start server.&quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>

    <span class="c1"># update value with stored defaults</span>
    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span>
                <span class="n">var_name</span>
            <span class="p">]</span><span class="o">.</span><span class="n">default</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;pva&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">])</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">value</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unable to connect to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span>

    <span class="c1"># update output variable values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_model</span><span class="p">()</span>
    <span class="n">model_outputs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="n">model_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="c1"># if startup hasn&#39;t failed</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_output_vars</span> <span class="o">=</span> <span class="n">model_outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_output_vars</span><span class="p">)</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">)</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_variables</span><span class="p">)</span>

        <span class="c1"># ignore interrupt in subprocess</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing pvAccess server&quot;</span><span class="p">)</span>

        <span class="c1"># initialize global inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure_specs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;serve&quot;</span><span class="p">]:</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">)</span>
                <span class="n">pvname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pvname&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">structure</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                        <span class="c1"># track fields in dict</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_parent_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_name</span>

                        <span class="n">variable</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">variable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> not found in variable list&quot;</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
                            <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">))</span>
                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
                            <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">))</span>
                            <span class="n">table_rep</span> <span class="o">=</span> <span class="p">()</span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                                <span class="c1"># here we assume double type in tables...</span>
                                <span class="n">table_rep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;ad&quot;</span><span class="p">)</span>

                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTTable</span><span class="p">(</span><span class="n">table_rep</span><span class="p">)</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                            <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
                                <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
                                <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                                <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                                <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">nd_array</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                            <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">))</span>

                            <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                            <span class="n">nd_array</span><span class="o">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                                <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                                <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                                <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                            <span class="p">}</span>

                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">nd_array</span><span class="p">)</span>

                        <span class="n">structure</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial</span>

                    <span class="c1"># assemble pv</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_structure_specs</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
                    <span class="n">struct_type</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
                    <span class="n">struct_value</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">struct_type</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
                    <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">struct_value</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">variable</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">variable_name</span><span class="p">]</span>
                    <span class="c1"># prepare scalar variable types</span>
                    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
                        <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
                        <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                    <span class="c1"># prepare image variable types</span>
                    <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                        <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                        <span class="n">nd_array</span><span class="o">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                            <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                            <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                            <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                        <span class="n">initial</span> <span class="o">=</span> <span class="n">nd_array</span>

                    <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span>
                        <span class="n">table_rep</span> <span class="o">=</span> <span class="p">()</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">variable</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="c1"># here we assume double type in tables...</span>
                            <span class="n">table_rep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;ad&quot;</span><span class="p">)</span>

                        <span class="n">nt</span> <span class="o">=</span> <span class="n">NTTable</span><span class="p">(</span><span class="n">table_rep</span><span class="p">)</span>
                        <span class="n">initial</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTScalar</span><span class="p">(</span><span class="s2">&quot;as&quot;</span><span class="p">)</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>
                            <span class="n">nt</span> <span class="o">=</span> <span class="n">NTNDArray</span><span class="p">()</span>
                            <span class="n">initial</span> <span class="o">=</span> <span class="n">nd_array</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Unsupported variable type provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
                        <span class="n">handler</span> <span class="o">=</span> <span class="n">PVAccessInputHandler</span><span class="p">(</span>
                            <span class="n">pvname</span><span class="o">=</span><span class="n">pvname</span><span class="p">,</span>
                            <span class="n">is_constant</span><span class="o">=</span><span class="n">variable</span><span class="o">.</span><span class="n">is_constant</span><span class="p">,</span>
                            <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">nt</span><span class="o">=</span><span class="n">nt</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span>

            <span class="c1"># if not serving pv, set up monitor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_monitors</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span>
                        <span class="n">pvname</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_callback</span><span class="p">,</span> <span class="n">pvname</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># in this case, externally hosted output variable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">:</span>
            <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pvname&quot;</span><span class="p">)</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">)</span>
            <span class="n">date_published</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_published&quot;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>

            <span class="n">spec</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;date_published&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;input_variables&quot;</span><span class="p">,</span> <span class="s2">&quot;as&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;output_variables&quot;</span><span class="p">,</span> <span class="s2">&quot;as&quot;</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span>
                <span class="s2">&quot;date_published&quot;</span><span class="p">:</span> <span class="n">date_published</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="n">owner</span><span class="p">,</span>
                <span class="s2">&quot;input_variables&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span>
                <span class="p">],</span>
                <span class="s2">&quot;output_variables&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_epics_config</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;pvname&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span>
                <span class="p">],</span>
            <span class="p">}</span>

            <span class="n">pv_type</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">pv_type</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="n">SharedPV</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span>

        <span class="c1"># initialize pva server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pva_server</span> <span class="o">=</span> <span class="n">P4PServer</span><span class="p">(</span><span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pvAccess server started&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAServer.shutdown" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shutdown</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Safely shutdown the server process.</p>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely shutdown the server process.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAServer.update_pv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_pv</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Adds update to input process variable to the input queue.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pvname</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Name of process variable</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>value</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span>, float]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Value to set</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_pv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds update to input process variable to the input queue.</span>

<span class="sd">    Args:</span>
<span class="sd">        pvname (str): Name of process variable</span>

<span class="sd">        value (Union[np.ndarray, float]): Value to set</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Hack for now to get the pickable value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">value</span>

    <span class="n">varname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pvname_to_varname_map</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>
    <span class="n">model_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>

    <span class="c1"># check for already cached variable</span>
    <span class="n">model_variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">model_variable</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
        <span class="n">model_variable</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x_min&quot;</span><span class="p">]</span>
        <span class="n">model_variable</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x_max&quot;</span><span class="p">]</span>
        <span class="n">model_variable</span><span class="o">.</span><span class="n">y_min</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y_min&quot;</span><span class="p">]</span>
        <span class="n">model_variable</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y_max&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_variable</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_variable</span>

    <span class="c1"># only update if not running</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running_indicator</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;vars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_values</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAServer.update_pvs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">update_pvs</span><span class="p">(</span><span class="n">input_variables</span><span class="p">,</span> <span class="n">output_variables</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update process variables over pvAccess.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.InputVariable">InputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dict of lume-epics output variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>output_variables</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="lume_model.variables.OutputVariable">OutputVariable</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dict of lume-model output variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_pvs</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InputVariable</span><span class="p">],</span>
    <span class="n">output_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OutputVariable</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update process variables over pvAccess.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_variables (Dict[str, InputVariable]): Dict of lume-epics output variables.</span>

<span class="sd">        output_variables (Dict[str, OutputVariable]): Dict of lume-model output variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">input_variables</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output_variables</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_parent_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_variables</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">is_constant</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot update constant variable.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;pvAccess image process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
                <span class="n">nd_array</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>

                <span class="c1"># get dw and dh from model output</span>
                <span class="n">nd_array</span><span class="o">.</span><span class="n">attrib</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span>
                    <span class="s2">&quot;y_min&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span>
                    <span class="s2">&quot;x_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span>
                    <span class="s2">&quot;y_max&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">nd_array</span>

            <span class="k">elif</span> <span class="n">variable</span><span class="o">.</span><span class="n">variable_type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;pvAccess array process variable </span><span class="si">%s</span><span class="s2"> updated.&quot;</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">NTNDArrayData</span><span class="p">)</span>

            <span class="c1"># do not build attribute pvs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;pvAccess process variable </span><span class="si">%s</span><span class="s2"> updated with value </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">variable</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># update structure or pv</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">struct_type</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure_specs</span><span class="p">[</span><span class="n">parent</span><span class="p">])</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">struct_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structures</span><span class="p">[</span><span class="n">parent</span><span class="p">])</span>
            <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="n">output_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pvname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_varname_to_pvname_map</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">output_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">[</span><span class="n">pvname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">output_provider</span><span class="p">:</span>
            <span class="n">output_provider</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># in this case externally hosted</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="lume_epics.epics_pva_server.PVAccessInputHandler" class="doc doc-heading">
        <code>PVAccessInputHandler</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Handler object that defines the callbacks to execute on put operations to input
process variables.</p>


        <details class="quote">
          <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PVAccessInputHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler object that defines the callbacks to execute on put operations to input</span>
<span class="sd">    process variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_constant</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="n">PVAServer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the handler with prefix and image pv attributes</span>

<span class="sd">        Args:</span>
<span class="sd">            pvname (str): The PV being handled</span>
<span class="sd">            is_constant (bool): Indicator of constant variable</span>
<span class="sd">            server (PVAServer): Reference to the server holding this PV</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_constant</span> <span class="o">=</span> <span class="n">is_constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvname</span> <span class="o">=</span> <span class="n">pvname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">:</span> <span class="n">SharedPV</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">ServOpWrap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the global input process variable state, posts the input process</span>
<span class="sd">        variable value change, runs the thread local BaseModel instance</span>
<span class="sd">        using the updated global input process variable states, and posts the model</span>
<span class="sd">        output values to the output process variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            pv (SharedPV): Input process variable on which the put operates.</span>

<span class="sd">            op (ServOpWrap): Server operation initiated by the put call.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update input values and global input process variable state</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_constant</span> <span class="ow">and</span> <span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pv</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_pv</span><span class="p">(</span><span class="n">pvname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
        <span class="c1"># mark server operation as complete</span>
        <span class="n">op</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAccessInputHandler.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">pvname</span><span class="p">,</span> <span class="n">is_constant</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the handler with prefix and image pv attributes</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pvname</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The PV being handled</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>is_constant</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Indicator of constant variable</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>server</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="lume_epics.epics_pva_server.PVAServer" href="#lume_epics.epics_pva_server.PVAServer">PVAServer</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Reference to the server holding this PV</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_constant</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="n">PVAServer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the handler with prefix and image pv attributes</span>

<span class="sd">    Args:</span>
<span class="sd">        pvname (str): The PV being handled</span>
<span class="sd">        is_constant (bool): Indicator of constant variable</span>
<span class="sd">        server (PVAServer): Reference to the server holding this PV</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_constant</span> <span class="o">=</span> <span class="n">is_constant</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pvname</span> <span class="o">=</span> <span class="n">pvname</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="lume_epics.epics_pva_server.PVAccessInputHandler.put" class="doc doc-heading">
<code class="highlight language-python"><span class="n">put</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Updates the global input process variable state, posts the input process
variable value change, runs the thread local BaseModel instance
using the updated global input process variable states, and posts the model
output values to the output process variables.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pv</code></td>
          <td>
                <code><span title="p4p.server.thread.SharedPV">SharedPV</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Input process variable on which the put operates.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>op</code></td>
          <td>
                <code><span title="p4p.server.raw.ServOpWrap">ServOpWrap</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Server operation initiated by the put call.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>lume_epics/epics_pva_server.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pv</span><span class="p">:</span> <span class="n">SharedPV</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="n">ServOpWrap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates the global input process variable state, posts the input process</span>
<span class="sd">    variable value change, runs the thread local BaseModel instance</span>
<span class="sd">    using the updated global input process variable states, and posts the model</span>
<span class="sd">    output values to the output process variables.</span>

<span class="sd">    Args:</span>
<span class="sd">        pv (SharedPV): Input process variable on which the put operates.</span>

<span class="sd">        op (ServOpWrap): Server operation initiated by the put call.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># update input values and global input process variable state</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_constant</span> <span class="ow">and</span> <span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pv</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_pv</span><span class="p">(</span><span class="n">pvname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pvname</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
    <span class="c1"># mark server operation as complete</span>
    <span class="n">op</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.integrate", "toc.follow", "navigation.top", "navigation.tabs"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.b425cdc4.min.js"></script>
      
    
  </body>
</html>